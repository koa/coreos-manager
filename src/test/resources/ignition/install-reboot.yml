#set( $D = '$' )
ignition:
  version: 2.0.0
systemd:
  units:
    - name: install.service
      enable: true
      contents: |
        [Unit]
        Requires=network-online.target
        After=network-online.target
        [Service]
        Type=oneshot
        ExecStart=/usr/bin/curl $baseUrl[0]/ignition?uuid=$uuid[0]&mac=$mac[0]&os=installed -o ignition.json
        ExecStart=/usr/bin/coreos-install -d $discs[0] -i ignition.json -b $baseUrl[0]proxy/alpha
        ExecStart=/usr/bin/udevadm settle
        ExecStart=/usr/bin/mount /dev/vda6 /boot/
#foreach($c in $console)
#if(!$c.isEmpty())
#if($c.startsWith("ttyS"))
        ExecStart=/usr/bin/sed -i 's/.${D}/ console=$c,115200n8 coreos.autologin=$c"/' /boot/grub.cfg
#else
        ExecStart=/usr/bin/sed -i 's/.${D}/ console=$c coreos.autologin=$c"/' /boot/grub.cfg
#end
#end
#end
        ExecStart=/usr/bin/udevadm settle
        ExecStart=/usr/bin/umount /boot/
        ExecStart=/usr/bin/systemctl reboot
        [Install]
        WantedBy=multi-user.target
#if($ssh_authorized_keys)
passwd:
  users:
    - name: core
      ssh_authorized_keys:
#foreach($key in $ssh_authorized_keys)
        - $key
#end
#end
        